name: Deploy Temple Site

on:
  push:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Debug - Show all files
      run: |
        echo "=== –°–û–î–ï–†–ñ–ò–ú–û–ï –†–ï–ü–û–ó–ò–¢–û–†–ò–Ø ==="
        find . -type f -name "*.txt" -o -name "*.py" | sort
        echo ""
        
        echo "=== requirements.txt (—Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å –Ω–æ–º–µ—Ä–∞–º–∏ —Å—Ç—Ä–æ–∫) ==="
        cat -n requirements.txt
        echo ""
        
        echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–≤–∏–¥–∏–º—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ ==="
        cat -A requirements.txt
        echo ""
        
        echo "=== –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ ==="
        wc -l requirements.txt
        echo ""
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies with debug
      run: |
        echo "=== –£–°–¢–ê–ù–û–í–ö–ê –ó–ê–í–ò–°–ò–ú–û–°–¢–ï–ô ==="
        python -m pip install --upgrade pip
        echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª requirements.txt..."
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        if [ ! -f "requirements.txt" ]; then
          echo "‚ùå –§–∞–π–ª requirements.txt –Ω–µ –Ω–∞–π–¥–µ–Ω!"
          exit 1
        fi
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –±—É–¥–µ–º —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å
        echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏:"
        while IFS= read -r line; do
          echo "  ‚Üí $line"
        done < requirements.txt
        
        # –ü—Ä–æ–±—É–µ–º —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
        echo "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
        pip install -r requirements.txt
        
        echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ"
    
    - name: Test Flask app
      run: |
        echo "=== –¢–ï–°–¢ –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ==="
        if [ -f "app.py" ]; then
          python -c "from app import app; print('‚úÖ Flask app import successful')"
        else
          echo "‚ùå –§–∞–π–ª app.py –Ω–µ –Ω–∞–π–¥–µ–Ω!"
          ls -la *.py
        fi

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519
        ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
    
    - name: Deploy to server
      run: |
        echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
        
        # –°–æ–∑–¥–∞–µ–º backup
        ssh -i ~/.ssh/id_ed25519 ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "
          cd /opt/temple_site
          TIMESTAMP=\$(date +%Y%m%d_%H%M%S)
          BACKUP_DIR=\"backups/\$TIMESTAMP\"
          mkdir -p \$BACKUP_DIR
          cp -f app.py requirements.txt \$BACKUP_DIR/ 2>/dev/null || true
          echo \"‚úÖ Backup —Å–æ–∑–¥–∞–Ω: \$BACKUP_DIR\"
        "
        
        # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã —Å –æ—Ç–ª–∞–¥–∫–æ–π
        echo "üìÅ –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
        
        echo "1. –ö–æ–ø–∏—Ä—É–µ–º requirements.txt..."
        scp -i ~/.ssh/id_ed25519 requirements.txt \
          ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:/opt/temple_site/
        
        echo "2. –ö–æ–ø–∏—Ä—É–µ–º app.py..."
        scp -i ~/.ssh/id_ed25519 app.py \
          ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:/opt/temple_site/
        
        # –ö–æ–ø–∏—Ä—É–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –µ—Å–ª–∏ –æ–Ω–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
        if [ -d "templates" ]; then
          echo "3. –ö–æ–ø–∏—Ä—É–µ–º templates..."
          scp -i ~/.ssh/id_ed25519 -r templates/ \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:/opt/temple_site/
        fi
        
        if [ -d "static" ]; then
          echo "4. –ö–æ–ø–∏—Ä—É–µ–º static..."
          scp -i ~/.ssh/id_ed25519 -r static/ \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:/opt/temple_site/
        fi
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º
        echo "‚öôÔ∏è –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å..."
        ssh -i ~/.ssh/id_ed25519 ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "
          echo '=== –ù–ê –°–ï–†–í–ï–†–ï ==='
          cd /opt/temple_site
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª–æ—Å—å
          echo '1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª—ã:'
          ls -la *.py *.txt
          echo ''
          
          echo '2. –°–æ–¥–µ—Ä–∂–∏–º–æ–µ requirements.txt:'
          cat requirements.txt
          echo ''
          
          # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º venv
          source venv/bin/activate
          
          # –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
          echo '3. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏...'
          pip install --upgrade pip
          pip install -r requirements.txt
          
          # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å
          echo '4. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å...'
          sudo systemctl daemon-reload
          sudo systemctl restart temple-site
          
          # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
          sleep 3
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º
          echo '5. –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞:'
          sudo systemctl status temple-site --no-pager | head -10
          
          echo '6. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏:'
          curl -f http://127.0.0.1:5001/health && echo '‚úÖ Health check passed' || echo '‚ùå Health check failed'
          
          echo 'üéâ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!'
        "